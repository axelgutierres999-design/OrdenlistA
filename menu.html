<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OrdenLista | Men√∫ y Pedidos</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
  <link rel="stylesheet" href="css/app.css" />
  <style>
    /* Estilos base */
    .tarjeta-producto {
      padding: 0;
      border: 1px solid #eee;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: white;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }
    .tarjeta-producto:hover {
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      transform: translateY(-4px);
      border-color: #10ad93;
    }
    .tarjeta-producto .info {
        padding: 1rem;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        flex-grow: 1;
    }
    .edit-btn { z-index: 20; }
    
    .panel-orden {
      background-color: #fff;
      padding: 1.5rem;
      border-radius: 16px;
      border: 1px solid #eef0f2;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      position: sticky;
      top: 2rem;
      transition: all 0.3s ease;
    }
    .panel-orden.llevar-activo {
      background: #f4fffc;
      border-color: #10ad93;
      box-shadow: 0 0 15px rgba(16,173,147,0.3);
    }
    
    .btn-llevar {
      background: #f4f4f4;
      border: 1px solid #ccc;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      color: #333;
      font-weight: 500;
    }
    .btn-llevar.activo {
      background: #10ad93;
      color: white;
      border-color: #10ad93;
    }
    
    .alerta-llevar {
      background: #e0fdf5;
      border: 1px solid #10ad93;
      color: #0a6b5f;
      padding: 8px;
      text-align: center;
      border-radius: 8px;
      margin-bottom: 10px;
      display: none;
    }
    .alerta-llevar.mostrar { display: block; }
    
    /* Bot√≥n flotante */
    .fab-add {
      position: fixed; bottom: 20px; right: 20px;
      background: #10ad93; color: white; font-size: 2rem;
      border: none; border-radius: 50%; width: 60px; height: 60px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 6px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 999;
    }

    /* --- ESTILOS NUEVOS PARA EL MODAL DE PAGO (Segun captura) --- */
    .btn-pago {
        display: block;
        width: 100%;
        margin-bottom: 15px;
        padding: 15px;
        font-size: 1.1rem;
        border-radius: 10px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.1s;
    }
    .btn-pago:active { transform: scale(0.98); }

    /* Estilo QR (Verde borde) */
    .btn-qr {
        background: white;
        border: 2px solid #10ad93;
        color: #10ad93;
    }
    /* Estilo Transferencia (Azul borde) */
    .btn-transfer {
        background: white;
        border: 2px solid #4a90e2;
        color: #4a90e2;
    }
    /* Estilo Terminal (Negro solido) */
    .btn-terminal {
        background: #333;
        border: 2px solid #333;
        color: white;
    }
  </style>
</head>
<body>

 <nav class="container-fluid nav-inicio" style="background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
  <ul style="display:flex; align-items:center; gap:0.6rem;">
    <li><strong style="font-size: 1.3rem; color: #10ad93;">‚òï OrdenLista</strong></li>
    <li style="color: #888;">| Pedidos</li>
    <li>
      <a href="ajustes.html" role="button" class="contrast"
         style="border:1px solid #10ad93; border-radius:8px; padding:4px 10px; color:#10ad93; text-decoration:none;">
        ‚öôÔ∏è Ajustes
      </a>
    </li>
  </ul>
  <ul id="menuNavegacion" class="nav-botones"></ul>
</nav>

  <main class="container">
    <header>
      <h1>üìú Men√∫ y Pedidos</h1>
      <p>Selecciona los productos para generar una nueva orden.</p>
    </header>

    <div class="buscador-container" style="display:flex; gap:10px; margin-bottom:20px;">
      <input type="search" id="buscarProducto" placeholder="üîç Buscar platillo..." style="flex:1;">
      <select id="filtroCategoria" style="width:auto;">
        <option value="Todos">Todas</option>
        <option value="Platillo">Platillos</option>
        <option value="Bebidas">Bebidas</option>
        <option value="Postres">Postres</option>
      </select>
    </div>

    <div class="grid">
      <section>
        <div id="contenedorProductos" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:1rem;">
          <article aria-busy="true">Cargando...</article>
        </div>
      </section>

      <section class="panel-orden" id="panelOrden">
        <div class="orden-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
          <h3 style="margin:0;">üõí Orden</h3>
          <button id="btnParaLlevar" class="btn-llevar">ü•° Para Llevar</button>
        </div>

        <div id="alertaLlevar" class="alerta-llevar">üì¶ Modo "Para Llevar" activado</div>

        <div id="listaItemsOrden" style="min-height:100px; margin-bottom:1rem; max-height:300px; overflow-y:auto;">
          <small style="display:block; text-align:center; color:#999;">Carrito vac√≠o</small>
        </div>

        <label for="comentarioPedido">üìù Nota General:</label>
        <textarea id="comentarioPedido" placeholder="Ej: Sin cubiertos..." rows="1" style="resize:none;"></textarea>

        <hr>
        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.5rem; color:#10ad93; margin-bottom:1rem;">
          <span>Total:</span><span id="ordenTotal">$0.00</span>
        </div>

        <label for="selectMesa">ü™ë Mesa:</label>
        <select id="selectMesa" required>
          <option value="" disabled selected>Selecciona mesa...</option>
        </select>

        <button id="btnProcesarOrden" style="width:100%; background:#10ad93; border:none;" disabled>
          üöÄ Procesar Pedido
        </button>
      </section>
    </div>
  </main>

  <button id="btnAgregarProducto" class="fab-add" title="Agregar producto" style="display:none;" onclick="window.abrirEditor()">Ôºã</button>

  <dialog id="modalEditarMenu" style="border:none; border-radius:15px; padding:0; width:90%; max-width:450px;">
    <div style="padding:20px;">
        <h3 style="margin-top:0;">‚úèÔ∏è Editar / Crear</h3>
        <form id="formProducto" style="display:flex; flex-direction:column; gap:12px;">
        <input type="hidden" id="editId">
        <div style="text-align:center; position:relative;">
            <img id="imgPreview" src="https://via.placeholder.com/150" 
                style="width:120px; height:120px; object-fit:cover; border-radius:10px; border:2px dashed #ccc; cursor:pointer;"
                title="Toca para subir imagen">
            <p style="font-size:12px; color:#666; margin:5px 0;">üì∏ Toca la imagen para subir foto</p>
        </div>
        <input type="hidden" id="editImg"> 
        <label>
            Nombre:
            <input type="text" id="editNombre" required>
        </label>
        <div style="display:flex; gap:10px;">
            <label style="flex:1">
            Precio:
            <input type="number" id="editPrecio" step="0.01" required>
            </label>
            <label style="flex:1">
            Categor√≠a:
            <select id="editCategoria">
                <option value="Platillo">Platillo</option>
                <option value="Bebidas">Bebidas</option>
                <option value="Postres">Postres</option>
                <option value="Otros">Otros</option>
            </select>
            </label>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button type="button" onclick="document.getElementById('modalEditarMenu').close()" style="flex:1; background:#ccc; border:none; color:black;">Cancelar</button>
            <button type="submit" style="flex:1; background:#10ad93; border:none;">Guardar</button>
        </div>
        <button type="button" id="btnEliminarProd" style="background:none; color:#e74c3c; border:1px solid #e74c3c; padding:8px; width:100%; margin-top:5px; display:none;">
            üóëÔ∏è Eliminar Platillo
        </button>
        </form>
    </div>
  </dialog>

  <dialog id="modalPagos">
    <article style="max-width: 480px; border-radius: 20px; text-align: center;">
      <header style="border-bottom:none;">
        <h3 style="margin-bottom: 5px;">üí≥ Tipo de Pago Digital</h3>
        <p style="color:#666;">Selecciona la opci√≥n para <strong>Llevar</strong></p>
        <h2 id="totalPagoModal" style="color:#10ad93; font-size:2.5rem; margin:10px 0;">$0.00</h2>
      </header>

      <section style="padding: 10px 20px;">
        <button class="btn-pago btn-qr" onclick="finalizarPago('QR / CoDi')">
            üì± C√≥digo QR (CoDi / App)
        </button>

        <button class="btn-pago btn-transfer" onclick="finalizarPago('Transferencia')">
            üè¢ Transferencia
        </button>

        <button class="btn-pago btn-terminal" onclick="finalizarPago('Terminal Bancaria')">
            üí≥ Terminal Bancaria
        </button>
        
        <button class="btn-pago" style="background:#f0f0f0; border:none; color:#333;" onclick="finalizarPago('Efectivo')">
            üíµ Efectivo
        </button>
      </section>

      <footer style="border-top:none;">
        <a href="#cancel" role="button" class="secondary" onclick="document.getElementById('modalPagos').close()" style="border:none;">
            Cancelar
        </a>
      </footer>
    </article>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-client.js"></script>
  <script src="js/app.js"></script>
  <script src="js/menu.js"></script> 

  <script>
    document.addEventListener("DOMContentLoaded", () => {
        const btnLlevar = document.getElementById("btnParaLlevar");
        const panel = document.getElementById("panelOrden");
        const alerta = document.getElementById("alertaLlevar");
        const selectMesa = document.getElementById("selectMesa");
        const btnProcesar = document.getElementById("btnProcesarOrden");
        const modalPagos = document.getElementById("modalPagos");
        const totalPagoModal = document.getElementById("totalPagoModal");
        const ordenTotal = document.getElementById("ordenTotal");

        // 1. L√≥gica del Bot√≥n "Para Llevar"
        btnLlevar.addEventListener("click", () => {
            btnLlevar.classList.toggle("activo");
            const esParaLlevar = btnLlevar.classList.contains("activo");

            if (esParaLlevar) {
                alerta.classList.add("mostrar");
                panel.classList.add("llevar-activo");
                selectMesa.value = ""; // Limpiar mesa
                selectMesa.disabled = true; // Deshabilitar selector
                
                // Si hay productos, habilitar el bot√≥n de procesar (ya que no requiere mesa)
                verificarBotonProcesar(true);
            } else {
                alerta.classList.remove("mostrar");
                panel.classList.remove("llevar-activo");
                selectMesa.disabled = false;
                verificarBotonProcesar(false);
            }
        });

        // Helper para habilitar/deshabilitar bot√≥n procesar
        function verificarBotonProcesar(esParaLlevar) {
            // Esta l√≥gica es visual, la l√≥gica real de validaci√≥n debe estar en tu app.js al renderizar carrito
            // Aqu√≠ asumimos que si hay items (total > 0) y es para llevar, se habilita.
            const totalTexto = ordenTotal.textContent.replace('$','');
            const total = parseFloat(totalTexto);
            
            if (total > 0) {
                if (esParaLlevar) {
                    btnProcesar.disabled = false;
                    btnProcesar.textContent = "ü•° Pagar y Entregar";
                } else {
                    // Si es mesa, depende de si seleccion√≥ mesa
                    btnProcesar.textContent = "üöÄ Procesar Pedido";
                    btnProcesar.disabled = selectMesa.value === "";
                }
            }
        }
        
        // Listener simple para cuando cambia el select de mesa
        selectMesa.addEventListener("change", () => verificarBotonProcesar(false));

        // 2. Interceptamos el click en Procesar
        btnProcesar.addEventListener("click", (e) => {
            const esParaLlevar = btnLlevar.classList.contains("activo");
            
            if (esParaLlevar) {
                // DETENER el env√≠o normal y mostrar MODAL
                e.preventDefault(); 
                e.stopPropagation();
                
                // Actualizar total en el modal
                totalPagoModal.textContent = ordenTotal.textContent;
                modalPagos.showModal();
            }
            // Si NO es para llevar, deja que app.js maneje el env√≠o a la mesa
        });

        // 3. Funci√≥n global para procesar el pago desde el modal
        window.finalizarPago = (metodo) => {
            console.log("Pago seleccionado:", metodo);
            // Aqu√≠ deber√≠as llamar a tu funci√≥n de guardar orden en Supabase
            // pasando el m√©todo de pago y marcando la orden como "completada" o "para llevar".
            
            alert(`‚úÖ Pedido Para Llevar registrado.\nPago: ${metodo}`);
            modalPagos.close();
            
            // Opcional: Recargar o limpiar carrito
            location.reload(); 
        };
    });
  </script>
</body>
</html>
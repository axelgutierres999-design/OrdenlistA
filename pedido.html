<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedido | OrdenLista</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <style>
    body { background: #f6f8f9; font-family: "Inter", system-ui, sans-serif; }
    
    header { text-align: center; margin-bottom: 1rem; padding-top: 10px; }
    header h1 { margin: 0.5rem 0; font-size: 1.6rem; color: #10ad93; }

    /* ESTILOS CARRUSEL (Men√∫ Digital) */
    #btnMenuDigital {
        display: none; /* Se muestra solo si hay fotos */
        background-color: #333;
        border: none;
        color: white;
        margin: 0 auto 15px auto;
        padding: 8px 15px;
        font-size: 0.9rem;
        border-radius: 20px;
        width: fit-content;
    }
    
    .carousel-container {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        height: 70vh; /* Altura del visor */
        background: black;
        border-radius: 8px;
        overflow: hidden;
    }
    .carousel-img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
    .c-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255,255,255,0.3);
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2rem;
        z-index: 10;
        display: flex; 
        align-items: center; 
        justify-content: center;
    }
    .c-prev { left: 10px; }
    .c-next { right: 10px; }
    .c-btn:hover { background: rgba(255,255,255,0.6); }

    /* Estilos Buscador y Productos */
    .buscador-container { display: flex; gap: 0.5rem; margin: 0 auto 1.5rem auto; flex-wrap: wrap; justify-content: center; max-width: 600px; }
    .buscador-container input, .buscador-container select { flex: 1; min-width: 120px; }

    .productos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
    .producto-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08); cursor: pointer; transition: transform 0.2s; }
    .producto-card:hover { transform: scale(1.03); }
    .producto-card img { width: 100%; height: 100px; object-fit: cover; }
    .producto-info { padding: 0.5rem 0.7rem; text-align: center; }
    .producto-info h4 { margin: 0.3rem 0; font-size: 1rem; }
    .producto-info p { margin: 0; color: #10ad93; font-weight: bold; }

    /* Carrito fijo */
    #carritoCliente { position: fixed; bottom: 0; left: 0; width: 100%; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); padding: 0.7rem 1rem; border-top: 2px solid #10ad93; z-index: 50; }
    #carritoCliente button { width: 100%; background: #10ad93; border: none; color: white; font-size: 1.1rem; padding: 0.7rem; border-radius: 8px; font-weight: 600; }
    #listaItemsCarrito { max-height: 230px; overflow-y: auto; margin-bottom: 0.5rem; }
    .item-carrito { background: #f9f9f9; border-radius: 8px; padding: 6px 8px; margin-bottom: 6px; display: flex; flex-direction: column; gap: 3px; }
    .item-top { display: flex; justify-content: space-between; align-items: center; }
    .btnQuitar { background: none; border: none; color: #e74c3c; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
    .item-comentario { font-size: 0.8rem; border: 1px solid #ddd; border-radius: 6px; padding: 4px; width: 100%; resize: none; }

    dialog { border: none; border-radius: 12px; max-width: 500px; width: 95%; }
  </style>
</head>
<body>

  <header>
    <p id="nombreMesa" style="margin:0; color:#888;">Mesa</p>
    <h1>‚òï OrdenLista</h1>
    
    <button id="btnMenuDigital" onclick="abrirMenuDigital()">üìñ Ver Men√∫ en Fotos</button>
  </header>

  <section class="buscador-container">
    <input type="search" id="buscarProducto" placeholder="Buscar platillo o bebida...">
    <select id="filtroCategoria">
      <option value="Todos">Todas las categor√≠as</option>
      <option value="Platillo">Platillos</option>
      <option value="Bebidas">Bebidas</option>
      <option value="Postres">Postres</option>
    </select>
  </section>

  <main class="container">
    <div id="productosCliente" class="productos-grid">
      <article aria-busy="true" style="text-align:center;">Cargando men√∫...</article>
    </div>
  </main>

  <section id="carritoCliente" hidden>
    <div id="listaItemsCarrito"></div>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
      <strong>Total:</strong> <span id="totalCliente">$0.00</span>
    </div>
    <textarea id="comentarioCliente" rows="2" placeholder="Comentario general al restaurante..." style="width:100%; margin-bottom:0.5rem;"></textarea>
    <button id="btnEnviarPedido">üöÄ Enviar Pedido</button>
  </section>

  <dialog id="modalMenuFotos">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <strong style="font-size:1.1rem;">Men√∫ del Restaurante</strong>
          <button onclick="document.getElementById('modalMenuFotos').close()" style="background:none; border:none; color:black; font-size:1.5rem; line-height:1;">&times;</button>
      </div>
      
      <div class="carousel-container">
          <button class="c-btn c-prev" onclick="cambiarSlide(-1)">‚ùÆ</button>
          <img id="imgSlide" class="carousel-img" src="" alt="Menu">
          <button class="c-btn c-next" onclick="cambiarSlide(1)">‚ùØ</button>
      </div>
      
      <div style="text-align:center; margin-top:10px; color:#666;">
          <span id="contadorSlide">1 / 1</span>
      </div>
  </dialog>

  <dialog id="modalConfirm">
    <article style="text-align:center;">
      <h3>‚úÖ Pedido enviado</h3>
      <p>Tu orden ha sido enviada al encargado.<br>Espera confirmaci√≥n.</p>
      <footer><button onclick="document.getElementById('modalConfirm').close()">Cerrar</button></footer>
    </article>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-client.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const mesaParam = params.get("mesa") || "Mesa";
    const ridParam = params.get("rid");

    document.getElementById("nombreMesa").textContent = mesaParam;

    let carrito = [];
    let productos = [];
    
    // VARIABLES PARA EL CARRUSEL
    let fotosMenu = [];
    let indiceFoto = 0;

    // 1. CARGA INICIAL (Productos + Fotos del Men√∫)
    async function cargarDatosRestaurante() {
      if (!ridParam) return alert("Error: restaurante no encontrado");

      // Cargar info del restaurante (para el men√∫ digital)
      const { data: resto } = await db.from("restaurantes").select("galeria_menu, menu_digital_url").eq("id", ridParam).single();
      
      if (resto) {
          // L√≥gica para detectar si hay fotos (array nuevo o string viejo)
          if (resto.galeria_menu && Array.isArray(resto.galeria_menu) && resto.galeria_menu.length > 0) {
              fotosMenu = resto.galeria_menu;
          } else if (resto.menu_digital_url) {
              fotosMenu = [resto.menu_digital_url];
          }

          // Si hay fotos, mostramos el bot√≥n
          if (fotosMenu.length > 0) {
              document.getElementById("btnMenuDigital").style.display = "block";
          }
      }

      // Cargar productos
      const { data, error } = await db.from("productos").select("*").eq("restaurante_id", ridParam);
      if (error) console.error(error);
      productos = data || [];
      renderizarProductos();
    }

    // 2. L√ìGICA DEL CARRUSEL
    window.abrirMenuDigital = () => {
        indiceFoto = 0;
        mostrarSlide();
        document.getElementById("modalMenuFotos").showModal();
    };

    window.cambiarSlide = (direccion) => {
        indiceFoto += direccion;
        if (indiceFoto < 0) indiceFoto = fotosMenu.length - 1;
        if (indiceFoto >= fotosMenu.length) indiceFoto = 0;
        mostrarSlide();
    };

    function mostrarSlide() {
        const img = document.getElementById("imgSlide");
        const counter = document.getElementById("contadorSlide");
        
        img.src = fotosMenu[indiceFoto];
        counter.textContent = `${indiceFoto + 1} / ${fotosMenu.length}`;
    }

    // 3. RENDERIZADO DE PRODUCTOS
    function renderizarProductos() {
      const cont = document.getElementById("productosCliente");
      const texto = document.getElementById("buscarProducto").value.toLowerCase();
      const categoria = document.getElementById("filtroCategoria").value;

      const filtrados = productos.filter(p => {
        const coincideNombre = p.nombre.toLowerCase().includes(texto);
        const coincideCat = categoria === "Todos" || p.categoria === categoria;
        return coincideNombre && coincideCat;
      });

      cont.innerHTML = "";
      if (filtrados.length === 0) {
        cont.innerHTML = `<p style="grid-column:1/-1; text-align:center; color:#999;">No hay productos encontrados</p>`;
        return;
      }

      filtrados.forEach(p => {
        const card = document.createElement("article");
        card.className = "producto-card";
        card.innerHTML = `
          <img src="${p.imagen_url || "https://via.placeholder.com/150"}" alt="${p.nombre}">
          <div class="producto-info">
            <h4>${p.nombre}</h4>
            <p>$${parseFloat(p.precio).toFixed(2)}</p>
          </div>`;
        card.onclick = () => agregarAlCarrito(p);
        cont.appendChild(card);
      });
    }

    // 4. L√ìGICA DE CARRITO
    function agregarAlCarrito(prod) {
      const itemUnico = { ...prod, cantidad: 1, comentario: "", tempId: Date.now() + Math.random() };
      carrito.push(itemUnico);
      renderizarCarrito();
    }

    function quitarDelCarrito(tempId) {
      carrito = carrito.filter(i => i.tempId !== tempId);
      renderizarCarrito();
    }

    function actualizarComentario(tempId, texto) {
      const item = carrito.find(i => i.tempId === tempId);
      if (item) item.comentario = texto;
    }

    function renderizarCarrito() {
      const cont = document.getElementById("listaItemsCarrito");
      const totalSpan = document.getElementById("totalCliente");
      const carritoSec = document.getElementById("carritoCliente");

      if (carrito.length === 0) {
        carritoSec.hidden = true;
        return;
      }

      carritoSec.hidden = false;
      cont.innerHTML = carrito.map(i => `
        <div class="item-carrito">
          <div class="item-top">
            <small>${i.cantidad}x ${i.nombre}</small>
            <div>
              <small>$${(i.cantidad * i.precio).toFixed(2)}</small>
              <button class="btnQuitar" onclick="quitarDelCarrito(${i.tempId})">‚úñ</button>
            </div>
          </div>
          <textarea class="item-comentario" placeholder="Nota (ej: Sin cebolla)..." 
            oninput="actualizarComentario(${i.tempId}, this.value)">${i.comentario || ""}</textarea>
        </div>`).join("");

      const total = carrito.reduce((acc, i) => acc + i.precio * i.cantidad, 0);
      totalSpan.textContent = `$${total.toFixed(2)}`;
    }

    // 5. ENVIAR PEDIDO
    document.getElementById("btnEnviarPedido").onclick = async () => {
      if (carrito.length === 0) return alert("Agrega productos primero.");

      const productosTexto = carrito.map(i => {
         const notaLimpia = i.comentario.replace(/,/g, '.'); 
         return `${i.cantidad}x ${i.nombre}${notaLimpia ? " [" + notaLimpia + "]" : ""}`;
      }).join(", ");

      const notasDePlatos = carrito.filter(i => i.comentario.trim() !== "").map(i => `üîπ${i.nombre}: ${i.comentario}`).join(" | ");
      const comentarioGeneral = document.getElementById("comentarioCliente").value.trim();
      
      let comentarioFinal = "";
      if (notasDePlatos) comentarioFinal += notasDePlatos;
      if (notasDePlatos && comentarioGeneral) comentarioFinal += " --- ";
      if (comentarioGeneral) comentarioFinal += `GENERAL: ${comentarioGeneral}`;

      const total = carrito.reduce((a, b) => a + b.precio * b.cantidad, 0);

      try {
        const { error } = await db.from("ordenes").insert([{
          restaurante_id: ridParam, mesa: mesaParam, productos: productosTexto,
          total, comentarios: comentarioFinal, estado: "por_confirmar"
        }]);
        
        if (error) throw error;
        carrito = []; renderizarCarrito(); document.getElementById("comentarioCliente").value = "";
        const modal = document.getElementById("modalConfirm");
        modal.showModal();
        setTimeout(() => { modal.close(); window.close(); }, 4000);
      } catch (err) { alert("Error al enviar pedido: " + err.message); }
    };

    document.getElementById("buscarProducto").addEventListener("input", renderizarProductos);
    document.getElementById("filtroCategoria").addEventListener("change", renderizarProductos);

    cargarDatosRestaurante();
  </script>
</body>
</html>
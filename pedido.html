<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedido | OrdenLista</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <style>
    body { background: #f6f8f9; font-family: "Inter", system-ui, sans-serif; padding-bottom: 120px; }
    
    header { text-align: center; margin-bottom: 1rem; padding-top: 10px; }
    header h1 { margin: 0.5rem 0; font-size: 1.6rem; color: #10ad93; }

    /* ESTILOS CARRUSEL */
    #btnMenuDigital {
        display: none;
        background-color: #333;
        border: none;
        color: white;
        margin: 0 auto 15px auto;
        padding: 8px 15px;
        font-size: 0.9rem;
        border-radius: 20px;
        width: fit-content;
    }
    
    .carousel-container {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        height: 75vh; /* Un poco m√°s alto para mejor vista */
        background: black;
        border-radius: 8px;
        overflow: hidden;
    }
    .carousel-img { max-width: 100%; max-height: 100%; object-fit: contain; }
    
    /* FLECHAS MEJORADAS */
    .c-btn {
        position: absolute; top: 50%; transform: translateY(-50%);
        background: rgba(0,0,0,0.5); color: white; border: none;
        width: 50px; height: 50px; border-radius: 50%; cursor: pointer;
        z-index: 10; display: flex; align-items: center; justify-content: center;
        font-size: 1.5rem; transition: background 0.3s;
    }
    .c-btn:hover { background: rgba(16, 173, 147, 0.8); }
    .c-prev { left: 15px; }
    .c-next { right: 15px; }

    /* Productos Grid */
    .productos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
    
    .producto-card { 
        background: white; border-radius: 12px; overflow: hidden; 
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08); position: relative;
        display: flex; flex-direction: column;
    }
    
    .producto-card img { width: 100%; height: 110px; object-fit: cover; cursor: pointer; }
    
    .btn-info-detalle {
        position: absolute; top: 8px; right: 8px;
        background: rgba(255,255,255,0.9); color: #10ad93;
        border: none; border-radius: 50%; width: 28px; height: 28px;
        font-weight: bold; font-family: serif; font-style: italic;
        cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        display: flex; align-items: center; justify-content: center; z-index: 5;
    }

    .producto-info { padding: 0.6rem; text-align: center; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
    .producto-info h4 { margin: 0; font-size: 0.95rem; line-height: 1.2; }
    .producto-info p { margin: 5px 0; color: #10ad93; font-weight: bold; }
    
    .btn-agregar-rapido {
        width: 100%; background: #10ad93; color: white; border: none;
        padding: 5px; border-radius: 6px; font-size: 0.8rem; cursor: pointer;
    }

    /* MODALES */
    dialog article { border-radius: 15px; overflow: hidden; }
    #modalInfoProducto article { max-width: 450px; padding: 0; }
    .detalle-img { width: 100%; height: 250px; object-fit: cover; }
    .detalle-cuerpo { padding: 20px; }
    .detalle-ingredientes { 
        background: #f0fdfa; border-left: 4px solid #10ad93; 
        padding: 15px; margin: 15px 0; font-size: 1rem; color: #333;
    }

    /* Carrito fijo */
    #carritoCliente { position: fixed; bottom: 0; left: 0; width: 100%; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); padding: 0.7rem 1rem; border-top: 2px solid #10ad93; z-index: 100; }
    #carritoCliente button { width: 100%; background: #10ad93; border: none; color: white; font-size: 1.1rem; padding: 0.7rem; border-radius: 8px; font-weight: 600; }
    #listaItemsCarrito { max-height: 200px; overflow-y: auto; margin-bottom: 0.5rem; }
    .item-carrito { background: #f9f9f9; border-radius: 8px; padding: 6px 8px; margin-bottom: 6px; }
    .item-top { display: flex; justify-content: space-between; align-items: center; }
    .item-comentario { font-size: 0.8rem; border: 1px solid #ddd; border-radius: 6px; padding: 4px; width: 100%; margin-top: 5px; }
  </style>
</head>
<body>

  <header>
    <p id="nombreMesa" style="margin:0; color:#888;">Cargando mesa...</p>
    <h1>‚òï OrdenLista</h1>
    <button id="btnMenuDigital" onclick="abrirMenuDigital()">üìñ Ver Men√∫ en Fotos</button>
  </header>

  <section class="container" style="margin-bottom: 1rem;">
    <div style="display:flex; gap:10px;">
        <input type="search" id="buscarProducto" placeholder="Buscar platillo..." style="margin:0;">
        <select id="filtroCategoria" style="margin:0; width:auto;">
            <option value="Todos">Categor√≠as</option>
            <option value="Platillo">Platillos</option>
            <option value="Bebidas">Bebidas</option>
            <option value="Postres">Postres</option>
        </select>
    </div>
  </section>

  <main class="container">
    <div id="productosCliente" class="productos-grid">
      <article aria-busy="true" style="text-align:center;">Cargando el men√∫...</article>
    </div>
  </main>

  <section id="carritoCliente" hidden>
    <div id="listaItemsCarrito"></div>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem; font-weight:bold;">
      <span>Total de tu orden:</span> <span id="totalCliente" style="color:#10ad93; font-size:1.2rem;">$0.00</span>
    </div>
    <textarea id="comentarioCliente" rows="1" placeholder="Nota general (ej: Cubiertos)..." style="width:100%; margin-bottom:0.5rem;"></textarea>
    <button id="btnEnviarPedido">üöÄ Confirmar y Enviar Pedido</button>
  </section>

  <dialog id="modalInfoProducto">
    <article>
      <header style="padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;">
        <strong id="detNombre" style="font-size: 1.2rem;">Detalles del Platillo</strong>
        <a href="#close" aria-label="Close" class="close" onclick="document.getElementById('modalInfoProducto').close()" style="font-size:1.5rem;"></a>
      </header>
      
      <img id="detImg" src="" class="detalle-img">
      
      <div class="detalle-cuerpo">
          <div style="display:flex; justify-content:space-between; align-items:center;">
              <span id="detCat" style="background:#eee; padding:2px 10px; border-radius:15px; font-size:0.8rem; color:#666;">Categor√≠a</span>
              <strong id="detPrecio" style="color:#10ad93; font-size:1.4rem;">$0.00</strong>
          </div>
          
          <div id="detIngredientes" class="detalle-ingredientes">
              Este platillo no tiene descripci√≥n adicional.
          </div>
          
          <button onclick="agregarActualAModal(); document.getElementById('modalInfoProducto').close();" style="width:100%; background:#10ad93; border:none; margin-top:10px;">
              ‚ûï Agregar a mi orden
          </button>
      </div>
    </article>
  </dialog>

  <dialog id="modalMenuFotos">
      <article style="max-width: 95vw; width: 600px;">
          <header>
            <strong>Men√∫ Visual</strong>
            <a href="#close" aria-label="Close" class="close" onclick="document.getElementById('modalMenuFotos').close()"></a>
          </header>
          <div class="carousel-container">
              <button class="c-btn c-prev" onclick="event.stopPropagation(); cambiarSlide(-1)">‚ùÆ</button>
              <img id="imgSlide" class="carousel-img" src="">
              <button class="c-btn c-next" onclick="event.stopPropagation(); cambiarSlide(1)">‚ùØ</button>
          </div>
          <footer style="text-align:center;"><span id="contadorSlide">1 / 1</span></footer>
      </article>
  </dialog>

  <dialog id="modalConfirm">
    <article style="text-align:center;">
      <h3>‚úÖ ¬°Pedido Enviado!</h3>
      <p>Estamos preparando tu orden.<br>Puedes ver el estado con el mesero.</p>
      <footer><button onclick="location.reload()">Aceptar</button></footer>
    </article>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-client.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const mesaParam = params.get("mesa") || "Mesa Sin N√∫mero";
    const ridParam = params.get("rid");

    document.getElementById("nombreMesa").textContent = "üìç " + mesaParam;

    let carrito = [];
    let productos = [];
    let productoSeleccionadoParaModal = null; 
    let fotosMenu = [];
    let indiceFoto = 0;

    // --- CERRAR MODALES AL TOCAR FUERA ---
    // Esta l√≥gica hace que si tocas el fondo oscuro (fuera del cuadro blanco), el modal se cierre.
    document.querySelectorAll('dialog').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.close();
        });
    });

    async function cargarDatosRestaurante() {
      if (!ridParam) return alert("ID de restaurante no v√°lido");

      const { data: resto } = await db.from("restaurantes").select("galeria_menu, menu_digital_url").eq("id", ridParam).single();
      if (resto) {
          // Cargamos la galer√≠a si existe, sino usamos la imagen √∫nica
          if (resto.galeria_menu && Array.isArray(resto.galeria_menu) && resto.galeria_menu.length > 0) {
              fotosMenu = resto.galeria_menu;
          } else if (resto.menu_digital_url) {
              fotosMenu = [resto.menu_digital_url];
          }
          
          if (fotosMenu.length > 0) document.getElementById("btnMenuDigital").style.display = "block";
      }

      const { data, error } = await db.from("productos").select("*").eq("restaurante_id", ridParam);
      productos = data || [];
      renderizarProductos();
    }

    window.verDetalles = (id) => {
        const p = productos.find(item => item.id === id);
        if(!p) return;
        
        productoSeleccionadoParaModal = p;
        document.getElementById("detNombre").textContent = p.nombre;
        document.getElementById("detPrecio").textContent = "$" + parseFloat(p.precio).toFixed(2);
        document.getElementById("detImg").src = p.imagen_url || "https://via.placeholder.com/150";
        document.getElementById("detCat").textContent = p.categoria || "General";
        
        const info = p.ingredientes || p.descripcion || "Sin descripci√≥n disponible.";
        document.getElementById("detIngredientes").innerHTML = `<b>Ingredientes:</b><br>${info}`;
        
        document.getElementById("modalInfoProducto").showModal();
    };

    window.agregarActualAModal = () => {
        if(productoSeleccionadoParaModal) agregarAlCarrito(productoSeleccionadoParaModal);
    };

    function renderizarProductos() {
      const cont = document.getElementById("productosCliente");
      const texto = document.getElementById("buscarProducto").value.toLowerCase();
      const categoria = document.getElementById("filtroCategoria").value;

      const filtrados = productos.filter(p => {
        const coincideNombre = p.nombre.toLowerCase().includes(texto);
        const coincideCat = categoria === "Todos" || p.categoria === categoria;
        return coincideNombre && coincideCat;
      });

      cont.innerHTML = "";
      filtrados.forEach(p => {
        const tieneInfo = (p.ingredientes && p.ingredientes.trim() !== "") || (p.descripcion && p.descripcion.trim() !== "");
        const card = document.createElement("article");
        card.className = "producto-card";
        card.innerHTML = `
          ${tieneInfo ? `<button class="btn-info-detalle" onclick="verDetalles('${p.id}')">i</button>` : ''}
          <img src="${p.imagen_url || "https://via.placeholder.com/150"}" onclick="verDetalles('${p.id}')">
          <div class="producto-info">
            <h4>${p.nombre}</h4>
            <p>$${parseFloat(p.precio).toFixed(2)}</p>
            <button class="btn-agregar-rapido" onclick="agregarAlCarritoById('${p.id}')">‚ûï Agregar</button>
          </div>`;
        cont.appendChild(card);
      });
    }

    window.agregarAlCarritoById = (id) => {
        const p = productos.find(i => i.id === id);
        if(p) agregarAlCarrito(p);
    };

    function agregarAlCarrito(prod) {
      const itemUnico = { ...prod, cantidad: 1, comentario: "", tempId: Date.now() + Math.random() };
      carrito.push(itemUnico);
      renderizarCarrito();
    }

    function renderizarCarrito() {
      const cont = document.getElementById("listaItemsCarrito");
      const totalSpan = document.getElementById("totalCliente");
      const carritoSec = document.getElementById("carritoCliente");

      if (carrito.length === 0) { carritoSec.hidden = true; return; }

      carritoSec.hidden = false;
      cont.innerHTML = carrito.map(i => `
        <div class="item-carrito">
          <div class="item-top">
            <strong>${i.nombre}</strong>
            <div>
              <span>$${i.precio.toFixed(2)}</span>
              <button style="background:none; border:none; color:red; padding:0 5px;" onclick="quitarDelCarrito(${i.tempId})">‚úñ</button>
            </div>
          </div>
          <input type="text" class="item-comentario" placeholder="Nota..." value="${i.comentario}" oninput="actualizarComentario(${i.tempId}, this.value)">
        </div>`).join("");

      const total = carrito.reduce((acc, i) => acc + i.precio * i.cantidad, 0);
      totalSpan.textContent = `$${total.toFixed(2)}`;
    }

    window.quitarDelCarrito = (tempId) => { carrito = carrito.filter(i => i.tempId !== tempId); renderizarCarrito(); };
    window.actualizarComentario = (tempId, texto) => { const item = carrito.find(i => i.tempId === tempId); if (item) item.comentario = texto; };

    document.getElementById("btnEnviarPedido").onclick = async () => {
      const btn = document.getElementById("btnEnviarPedido");
      btn.disabled = true; btn.textContent = "Enviando...";

      const productosTexto = carrito.map(i => `${i.cantidad}x ${i.nombre}${i.comentario ? " ["+i.comentario+"]" : ""}`).join(", ");
      const total = carrito.reduce((a, b) => a + b.precio * b.cantidad, 0);
      const comentarioGeneral = document.getElementById("comentarioCliente").value;

      try {
        const { error } = await db.from("ordenes").insert([{
          restaurante_id: ridParam, mesa: mesaParam, productos: productosTexto,
          total, comentarios: comentarioGeneral, estado: "por_confirmar"
        }]);
        if (error) throw error;
        document.getElementById("modalConfirm").showModal();
      } catch (err) { alert("Error: " + err.message); btn.disabled = false; btn.textContent = "Reintentar"; }
    };

    // --- L√ìGICA CARRUSEL MEJORADA ---
    window.abrirMenuDigital = () => { 
        if(fotosMenu.length === 0) return;
        indiceFoto = 0; 
        mostrarSlide(); 
        document.getElementById("modalMenuFotos").showModal(); 
    };

    window.cambiarSlide = (d) => { 
        indiceFoto += d; 
        if (indiceFoto < 0) indiceFoto = fotosMenu.length - 1; 
        if (indiceFoto >= fotosMenu.length) indiceFoto = 0; 
        mostrarSlide(); 
    };

    function mostrarSlide() { 
        const img = document.getElementById("imgSlide");
        img.src = fotosMenu[indiceFoto]; 
        document.getElementById("contadorSlide").textContent = `${indiceFoto + 1} / ${fotosMenu.length}`; 
    }

    document.getElementById("buscarProducto").addEventListener("input", renderizarProductos);
    document.getElementById("filtroCategoria").addEventListener("change", renderizarProductos);

    cargarDatosRestaurante();
  </script>
</body>
</html>